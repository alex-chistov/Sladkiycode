# 🔗 Интеграция админки с формой loba4

## Что добавлено

### 1. Загрузка заявок по ID из URL

Теперь админка может открывать заявки напрямую по ссылке:

```
http://localhost:3000/adminka/index.html?id=123
```

При открытии страницы с параметром `?id=X`:

- ✅ Автоматически загружаются данные заявки из БД
- ✅ Все поля формы заполняются данными из БД
- ✅ Загружается история изменений заявки
- ✅ ID отображается в заголовке и всех полях

### 2. Автоматическое заполнение формы

Заполняются все поля на вкладке "Подробно":

- `#` - ID заявки
- `Заголовок` - title
- `Описание` - description
- `Тип проблемы` - problem_type
- `ЕСИА` - esia
- `Автор` - author (ФИО)
- `Email автора` - author_email
- `Телефон автора` - author_phone
- `Адрес автора` - author_address
- `Видно всем` - visible_to_all
- `Публиковать результат` - publish_result
- `Назначен` - assigned_to
- `Дата создания` - created_at
- `Срок исполнения` - deadline
- `Внешняя система` - external_system (Лобачевский/Сайт lbch.ru)
- `Статус` - status

### 3. Список всех заявок

Создана новая страница `list.html`:

```
http://localhost:3000/adminka/list.html
```

Функционал:

- 📊 Таблица всех заявок из БД
- 🔍 Отображение основной информации (ID, автор, телефон, статус)
- 🎨 Цветные бейджи статусов
- 🖱️ Клик по заявке открывает её для редактирования
- 🔄 Кнопка обновления списка

### 4. Навигация

#### Кнопка "Список" в админке

На странице `index.html` кнопка "Список" теперь ведет на `list.html`

#### Кнопка "Открыть в админке" в личном кабинете

На странице детального просмотра заявки в loba4 (`complaint-detail.html`) добавлена кнопка "Открыть в админке", которая открывает заявку в админ-панели в новой вкладке.

### 5. Обновленные функции сохранения

#### Редактирование заявки

- При наличии ID в URL - обновляет существующую заявку
- Без ID - создает новую заявку
- После сохранения автоматически перезагружает данные

#### Обработка заявки

- Использует ID из URL
- Обновляет статус и назначение
- Добавляет записи в историю
- Перезагружает данные после сохранения

## Как использовать

### Вариант 1: Из личного кабинета жителя

```
1. Житель создает заявку → loba4/index.html
2. Заявка сохраняется в БД
3. Житель видит заявку в личном кабинете → loba4/my-applications.html
4. Кликает по заявке → loba4/complaint-detail.html?id=X
5. Нажимает "Открыть в админке"
6. Открывается админка с заполненными данными → adminka/index.html?id=X
```

### Вариант 2: Через список заявок в админке

```
1. Открываем список → http://localhost:3000/adminka/list.html
2. Видим все заявки из БД
3. Кликаем по нужной заявке
4. Открывается форма с заполненными данными
```

### Вариант 3: Прямая ссылка

```
http://localhost:3000/adminka/index.html?id=123
```

## Схема работы

```
┌─────────────────────────────────────────────────────────────┐
│                    ФОРМА LOBA4 (Житель)                     │
│                                                               │
│  1. Подача заявки → БД (ID = 123)                           │
│  2. Просмотр в личном кабинете                               │
│  3. Клик "Открыть в админке"                                │
│                                                               │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    АДМИНКА (Сотрудник)                       │
│                                                               │
│  adminka/index.html?id=123                                   │
│                                                               │
│  1. Загрузка данных из БД                                    │
│  2. Автозаполнение всех полей                               │
│  3. Редактирование данных                                    │
│  4. Обработка заявки (смена статуса)                        │
│  5. Сохранение изменений в БД                                │
│                                                               │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    БАЗА ДАННЫХ SQLite                        │
│                                                               │
│  complaints.db → таблица complaints                          │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## Примеры использования

### Пример 1: Редактирование заявки жителя

```javascript
// 1. Житель создал заявку в loba4
// БД: ID = 5, автор = "Иванов Иван", телефон = "+7 904 904-13-28"

// 2. Открываем в админке:
http://localhost:3000/adminka/index.html?id=5

// 3. Видим заполненные поля:
// - Автор: "Иванов Иван"
// - Телефон: "+7 904 904-13-28"
// - Адрес: указанный в заявке
// - и т.д.

// 4. Редактируем, нажимаем "Сохранить"
// → Данные обновляются в БД

// 5. Житель видит обновления в личном кабинете
```

### Пример 2: Обработка заявки

```javascript
// 1. Открываем заявку
http://localhost:3000/adminka/index.html?id=10

// 2. Переходим на вкладку "Обработка"
// 3. Выбираем действие: "Взято в работу"
// 4. Назначаем исполнителя
// 5. Пишем официальный ответ
// 6. Нажимаем "Отправить"

// → Статус обновляется в БД
// → Запись добавляется в историю
// → Житель видит новый статус в личном кабинете
```

## Обновленные функции в script.js

### `getComplaintIdFromUrl()`

Получает ID заявки из URL параметра

### `loadComplaintData()`

Загружает заявку из БД и заполняет форму

### `fillFormFields(complaint)`

Заполняет все поля формы данными заявки

### `updateProcessingTab(complaint)`

Обновляет поля на вкладке "Обработка"

### `loadHistory(complaintId)`

Загружает историю изменений заявки

### `renderHistory(historyData)`

Отображает историю в таблице

## Тестирование

### Тест 1: Создание и открытие заявки

```bash
# 1. Запустите сервер
cd adminka
npm start

# 2. Создайте заявку через форму
http://localhost:3000/loba4/index.html

# 3. Запомните ID заявки (например, 15)

# 4. Откройте в админке
http://localhost:3000/adminka/index.html?id=15

# Ожидаемый результат:
# ✅ Все поля заполнены данными из заявки
```

### Тест 2: Список заявок

```bash
# 1. Откройте список
http://localhost:3000/adminka/list.html

# Ожидаемый результат:
# ✅ Таблица со всеми заявками из БД
# ✅ Клик по заявке открывает её
```

### Тест 3: Редактирование

```bash
# 1. Откройте заявку по ID
http://localhost:3000/adminka/index.html?id=5

# 2. Нажмите "Редактировать"
# 3. Измените данные
# 4. Нажмите "Сохранить"

# Ожидаемый результат:
# ✅ Данные сохранены в БД
# ✅ Запись добавлена в историю
```

## Возможные проблемы

### Заявка не загружается

**Причина:** Сервер не запущен или ID не существует

**Решение:**

```bash
cd adminka
npm start
```

### Поля не заполняются

**Причина:** Несоответствие структуры БД

**Решение:** Проверьте, что в БД есть все необходимые поля

### Ошибка при сохранении

**Причина:** Нет прав на запись в БД

**Решение:** Проверьте права доступа к файлу `complaints.db`

## Дополнительные возможности

### Добавить фильтрацию в список

В файле `list.html` можно добавить поиск и фильтры:

- По статусу
- По дате
- По исполнителю
- По источнику

### Добавить массовые операции

Можно добавить функционал:

- Массовое изменение статуса
- Массовое назначение исполнителя
- Экспорт в Excel

### Интеграция с уведомлениями

При изменении статуса можно:

- Отправлять SMS жителю
- Отправлять Email
- Создавать push-уведомления

---

**Версия:** 1.0.0  
**Дата:** 21 ноября 2025  
**Статус:** ✅ Полностью функционально

