# 🔗 Интеграция формы loba4 с базой данных

## Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                    ФОРМА LOBA4 (Фронтенд)                   │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐    ┌──────────────┐    ┌───────────────┐ │
│  │  index.html  │───▶│  step2.html  │───▶│my-applications│ │
│  │  (Шаг 1)     │    │  (Шаг 2)     │    │   .html       │ │
│  └──────────────┘    └──────────────┘    └───────────────┘ │
│         │                    │                    │          │
│         │                    │                    │          │
│         └────────────────────┴────────────────────┘          │
│                              │                                │
│                    ┌─────────▼──────────┐                    │
│                    │  api-client.js     │                    │
│                    │  (API Клиент)      │                    │
│                    └─────────┬──────────┘                    │
└──────────────────────────────┼───────────────────────────────┘
                               │ HTTP REST API
                               │
┌──────────────────────────────▼───────────────────────────────┐
│                    СЕРВЕР (Backend)                           │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐    ┌──────────────┐    ┌───────────────┐ │
│  │  server.js   │───▶│ database.js  │───▶│ complaints.db │ │
│  │  (Express)   │    │  (SQLite)    │    │   (SQLite)    │ │
│  └──────────────┘    └──────────────┘    └───────────────┘ │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

## Поток данных

### 1. Подача заявки

```
Пользователь → index.html → sessionStorage → step2.html
                                                   ↓
                                         Собирает данные
                                                   ↓
                                         api-client.js
                                                   ↓
                                    POST /api/complaints
                                                   ↓
                                              server.js
                                                   ↓
                                            database.js
                                                   ↓
                                          complaints.db
                                                   ↓
                                    Возврат ID заявки
                                                   ↓
                                    my-applications.html
```

### 2. Просмотр заявок

```
Пользователь → my-applications.html
                        ↓
               Читает номер телефона из localStorage
                        ↓
                  api-client.js
                        ↓
         GET /api/complaints-by-phone/:phone
                        ↓
                   server.js
                        ↓
                 database.js
                        ↓
              SELECT * FROM complaints
              WHERE author_phone = ?
                        ↓
              Возврат списка заявок
                        ↓
           Отображение на странице
```

## Структура данных

### Данные формы → Поля БД

| Поле формы  | Поле БД         | Описание                     |
| ----------- | --------------- | ---------------------------- |
| description | description     | Описание проблемы            |
| address     | author_address  | Адрес проблемы               |
| address     | title           | Также используется как title |
| lastName    | author          | Часть полного имени          |
| firstName   | author          | Часть полного имени          |
| middleName  | author          | Часть полного имени          |
| phone       | author_phone    | Телефон заявителя            |
| files       | attachments     | Прикрепленные файлы (TODO)   |
| -           | status          | "Новое" (по умолчанию)       |
| -           | external_system | "Сайт lbch.ru"               |
| -           | created_date    | Дата создания                |

### Пример объекта заявки

```javascript
{
  "title": "ул. Ленина, д. 10",
  "description": "Яма на дороге, требует ремонта",
  "author": "Иванов Иван Иванович",
  "author_phone": "+7 (904) 904-13-28",
  "author_address": "ул. Ленина, д. 10",
  "status": "Новое",
  "external_system": "Сайт lbch.ru",
  "created_date": "2025-11-21T10:30:00.000Z"
}
```

## API Endpoints

### POST /api/complaints

**Создание новой заявки**

Request:

```json
{
  "title": "Заголовок заявки",
  "description": "Описание проблемы",
  "author": "ФИО",
  "author_phone": "+7 (XXX) XXX-XX-XX",
  "author_address": "Адрес",
  "status": "Новое",
  "external_system": "Сайт lbch.ru"
}
```

Response:

```json
{
  "message": "Заявка создана успешно",
  "id": 123
}
```

### GET /api/complaints-by-phone/:phone

**Получение заявок по телефону**

Request:

```
GET /api/complaints-by-phone/+7 (904) 904-13-28
```

Response:

```json
{
  "data": [
    {
      "id": 123,
      "title": "...",
      "description": "...",
      "author": "...",
      "author_phone": "+7 (904) 904-13-28",
      "status": "Новое",
      "created_at": "2025-11-21T10:30:00.000Z"
    }
  ]
}
```

### GET /api/complaints/:id

**Получение заявки по ID**

Request:

```
GET /api/complaints/123
```

Response:

```json
{
  "data": {
    "id": 123,
    "title": "...",
    "description": "...",
    "author": "...",
    "author_phone": "...",
    "status": "Новое",
    "created_at": "2025-11-21T10:30:00.000Z"
  }
}
```

## Хранилище данных

### sessionStorage

**Временные данные между шагами формы**

```javascript
{
  "description": "Описание проблемы",
  "address": "Адрес проблемы",
  "filesCount": 2
}
```

Ключ: `step1Data`  
Очищается: после отправки заявки

### localStorage

**Постоянные данные пользователя**

```javascript
{
  "userPhone": "+7 (904) 904-13-28",
  "lastComplaintId": "123"
}
```

Используется для:

- Автозаполнения номера телефона в личном кабинете
- Отображения последней созданной заявки

## Статусы заявок

### Активные

- Новое
- Принято в работу
- На рассмотрении
- В работе

### Закрытые

- Решено
- Отклонено
- Закрыто
- Выполнено

## Безопасность

### CORS

Сервер настроен на прием запросов с любых доменов:

```javascript
app.use(cors());
```

В продакшене рекомендуется ограничить:

```javascript
app.use(
  cors({
    origin: "https://yourdomain.com",
  })
);
```

### Валидация

Клиентская валидация:

- Обязательные поля (HTML5 required)
- Формат телефона (маска ввода)
- Лимит файлов (до 4 файлов)
- Согласие на обработку данных

Серверная валидация:

- TODO: добавить проверку данных на сервере

## Масштабирование

### Текущие ограничения

- SQLite (однопоточный)
- Локальное хранилище файлов
- Без аутентификации

### Рекомендации для продакшена

1. Перейти на PostgreSQL/MySQL
2. Добавить загрузку файлов на S3/Cloudinary
3. Реализовать JWT аутентификацию
4. Добавить rate limiting
5. Логирование запросов
6. Мониторинг и алерты

## Тестирование

### Ручное тестирование

1. Откройте `http://localhost:3000/loba4/test-api.html`
2. Проверьте все функции
3. Проверьте консоль браузера (F12)

### Тестовые данные

- **Телефон:** +7 (904) 904-13-28
- **ФИО:** Тестовый Пользователь Тестович
- **Адрес:** ул. Тестовая, д. 1

## Поддержка

При возникновении проблем:

1. Проверьте логи сервера в терминале
2. Откройте консоль браузера (F12)
3. Проверьте файл `adminka/complaints.db`
4. См. `TROUBLESHOOTING.md` в папке adminka

---

**Версия:** 1.0.0  
**Дата:** 2025-11-21  
**Статус:** ✅ Полностью функционально
